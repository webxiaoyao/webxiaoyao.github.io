<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
	<div>
		<div>
			<label for="">audio Source</label>
			<select name="" id="audioSource"></select>
		</div>
		<div>
			<label for="">audio output</label>
			<select name="" id="audioOutput"></select>
		</div>
		<div>
			<label for="">video Source</label>
			<select name="" id="videoSource"></select>
		</div>
		<video autoplay playsinline id="player"></video>
		<!-- <div>
			<button id="snap-shot">Take snapShot</button>
		</div>
		<div>
			<canvas id="picture"></canvas>
		</div> -->
		<div>
			<video playsinline id="recPlayer"></video>
		</div>
		<div>
			<button id="start">开始录制</button>
			<button id="play">播放录制</button>
			<button id="download">下载</button>
		</div>
	</div>
	<script>
		function gotUserMedia(stream) {
			var video = document.querySelector('#player')
			video.srcObject = stream
			window.stream = stream
			return navigator.mediaDevices.enumerateDevices()
		}
		function gotMediaDevices(devicesInfos) {
			var audioSource = document.querySelector('select#audioSource')
			var audioOutput = document.querySelector('select#audioOutput')
			var videoSource = document.querySelector('select#videoSource')
			devicesInfos.forEach(function (deviceInfo) {
				var option = document.createElement('option')
				option.text = deviceInfo.label
				option.value = deviceInfo.deviceId
				if (deviceInfo.kind === 'audioinput') {
					audioSource.appendChild(option)
				} else if (deviceInfo.kind === 'audiooutput') {
					audioOutput.appendChild(option)
				} else if (deviceInfo.kind === 'videoinput') {
					videoSource.appendChild(option)
				}
			})
		}
		function init() {
			if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
				console.log('当前浏览器不支持')
				return
			}
			var constraints = {
				video: {
					width: 320,
					height: 240,
					frameRate: 30, // 帧
					facingMode: 'environment' // 后置摄像头 user前置摄像头
				},
				audio: true
			}
			navigator.mediaDevices.getUserMedia(constraints)
							.then(gotUserMedia)
							.then(gotMediaDevices)
							.catch(err => {
								console.log('err' + err)
							})
		}
		init()
		var recVedio = document.querySelector('video#recPlayer')
		var btnRecord = document.querySelector('button#start')
		var btnPlay = document.querySelector('button#play')
		var btnDownload = document.querySelector('button#download')
		var mediaRecorder
		var buffer
		// var snapShot = document.querySelector('button#snap-shot')
		// snapShot.onclick = function () {
		// 	var picture= document.querySelector('canvas#picture')
		// 	picture.width = 320
		// 	picture.height = 240
		// 	var video = document.querySelector('#player')
		// 	picture.getContext('2d').drawImage(video, 0, 0, picture.width, picture.height)
		// }
		btnRecord.onclick = function () {
			if (btnRecord.innerText === '开始录制') {
				startRecord()
				btnRecord.innerText === '结束录制'
			} else {
				endRecord()
				btnRecord = '开始录制'
			}
		}
		function startRecord() {
			buffer = []
			var options = {
				mimeType: 'video/webm;codecs=vp8'
			}
			if (!MediaRecorder.isTypeSupported) {
				console.error('此种视频格式不支持录制')
				return
			}
			try {
				mediaRecorder = new MediaRecorder(window.stream, options)
			} catch(e) {
				console.error('fail to create mediaRecorder', e)
				return
			}
			mediaRecorder.ondataavailable = handleDataAvailable
			mediaRecorder.start(10)
		}
		function handleDataAvailable(e) {
			if (e && e.data && e.datasize) {
				buffer.push(e.data)
			}
		}
		function endRecord() {
			mediaRecorder.stop()
		}
		btnPlay.onclick = function () {
			var blob = new Blob(buffer, {type: 'video/webm'})
			recVedio.src = window.URL.createObjectURL(blob)
			recVedio.srcObject = null
			recVedio.controls = true
			recVedio.play()
		}
	</script>
</body>
</html>